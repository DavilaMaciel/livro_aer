# Diversidade Funcional {#cap14}

## Pr√©-requisitos do cap√≠tulo {-}

Pacotes, dados e fun√ß√µes que ser√£o utilizados neste cap√≠tulo.

```{r message=FALSE, warning=FALSE}
## Pacotes 
library(FD)
library(ade4)
library(ecodados)
library(gridExtra)
library(ggplot2)
library(ggrepel)
library(tidyverse)
library(picante)
library(vegan)
library(SYNCSA)
library(GGally)
library(FD)
library(betapart)
library(nlme)
library(ape)
library(TPD)
library(cati)
library(kableExtra)

## Dados e fun√ß√µes
comun_fren_dat <- ecodados::fundiv_frenette2012a_comu
ambie_fren_dat <- ecodados::fundiv_frenette2012a_amb
trait_fren_dat <- ecodados::fundiv_frenette2012a_trait
trait_dat      <- ecodados::fundiv_barbaro2009a_trait
comun_dat      <- ecodados::fundiv_barbaro2009a_comu
ambie_dat      <- ecodados::fundiv_barbaro2009a_amb
trait_baselga  <- ecodados::trait_baselga
comm_baselga   <- ecodados::comm_baselga
anuros_comm    <- ecodados::anuros_comm
traits         <- ecodados::traits
env            <- ecodados::env
# ecodados::wITV # funtion: wITV
```

## Aspectos te√≥ricos

At√© a d√©cada de 1990, a teoria ecol√≥gica investigava basicamente quais processos determinavam a abund√¢ncia e riqueza de esp√©cies no espa√ßo e tempo. As d√©cadas de 1980 e 1990 foram marcadas por intensos debates sobre as regras de montagem de comunidades e como intera√ß√µes e filtros ambientais determinavam a coexist√™ncia de esp√©cies [@strong_ecological_1984]. Por√©m, a d√©cada de 2000 foi marcada pelo uso mais expl√≠cito da caracter√≠sticas das esp√©cies como uma vari√°vel fundamental tanto para explicar como a distribui√ß√£o dos organismos seria afetada pelo ambiente, quanto para entender como tais esp√©cies afetariam o ecossistema [@diaz_vive_2001; @mcgill_rebuilding_2006]. O primeiro estudo que utilizou o termo *Diversidade Funcional* foi publicado por Williams [-@anderson1967], que comparou esp√©cies de na√∫plios filogeneticamente relacionadas e demonstrou que elas possuem alta plasticidade funcional que favorecem ampla varia√ß√£o de comportamentos e, desse modo, permitem que sejam esp√©cies generalistas em ambientes em constante mudan√ßa. A unidade b√°sica desses estudos, o atributo funcional (do ingl√™s "*functional trait*"), √© definido como uma propriedade mensur√°vel dos organismos (geralmente em n√≠vel individual) que represente caracter√≠sticas morfol√≥gicas, fisiol√≥gicas ou fenol√≥gicas que afetam a aptid√£o alterando aspectos do crescimento, reprodu√ß√£o e sobreviv√™ncia [@violle_let_2007]. Mais especificamente, o atributo funcional pode ser divido em **atributo efeito** (i.e., atributos do organismo que afetam condi√ß√µes ambientais ou propriedades do ecossistema) e **atributo resposta** (i.e., atributos do organismo que variam em resposta a condi√ß√µes ambientais) [@violle_let_2007].

Dessa forma, as medidas de diversidade passaram a ser representadas n√£o somente por diferen√ßas no n√∫mero e na quantidade de esp√©cies, mas pelas diferen√ßas e/ou semelhan√ßas dos atributos funcionais das esp√©cies dentro e entre localidades. Assim, a varia√ß√£o no grau de express√£o de diferentes atributos funcionais entre diferentes popula√ß√µes, comunidades ou ecossistemas √© definida como *Diversidade Funcional* [*sensu* @garnier_plant_2015]. Por√©m, a diversidade funcional n√£o deve ser usada como medida √∫nica, uma vez que tais diferen√ßas entre os atributos funcionais podem ser medida a partir da abund√¢ncia relativa, riqueza e varia√ß√£o dos atributos funcionais. Desse modo, podemos dividir a diversidade funcional em tr√™s diferentes medidas: i) riqueza funcional, ii) diverg√™ncia funcional, e iii) regularidade funcional [@villeger_new_2008]. Existem dezenas de m√©tricas que calculam cada uma dessas *dimens√µes* da diversidade funcional, mas se destacam aquelas baseadas em dendrograma [e.g., FD: @petchey_functional_2002] ou em medidas de dist√¢ncia [e.g., @villeger_new_2008]. Assim como a diversidade taxon√¥mica (Cap√≠tulo \@ref(cap12)), a diversidade funcional pode ser medida em componentes alfa e beta. A seguir, apresentamos diferentes maneiras de calcular a dist√¢ncia entre localidades tendo como base os atributos funcionais das esp√©cies e, al√©m disso, demonstramos como calcular algumas das m√©tricas de diversidade (alfa e beta) funcional mais usadas em Ecologia. A parte final deste cap√≠tulo apresenta dois exemplos de como podemos testar hip√≥teses ecol√≥gicas comparando a diversidade funcional alfa e beta.

## Definindo a dis(similaridade) entre esp√©cies

Definir o qu√£o diferente ou semelhante s√£o duas esp√©cies que ocorrem em uma determinada localidade √© a base para calcular a diversidade alfa e beta funcional. Para isso, √© fundamental ter em mente que os atributos funcionais podem ser de v√°rios tipos como, por exemplo, cont√≠nuos (e.g., tamanho corporal em cent√≠metro), categ√≥ricos (e.g., guilda: frug√≠voro, detrit√≠voro, etc.), ordinais (e.g., 1 para organismo at√© 5 cm, 2 para organismos entre 5 e 30 cm, e 3 para organismos maiores do que 30 cm), bin√°rios (e.g., presen√ßa ou aus√™ncia de espinho), entre outros [veja a Figura \@ref(fig:fig-statistical-thinking) no Cap√≠tulo \@ref(cap2)]. Por este motivo, a decis√£o do m√©todo de dist√¢ncia s√≥ ser√° poss√≠vel ap√≥s o reconhecimento dos tipos de atributos funcionais escolhidos. Em linhas gerais, para vari√°veis cont√≠nuas a dist√¢ncia euclidiana √© a melhor op√ß√£o, enquanto para os outros tipos de vari√°veis ou para conjuntos de atributos com mais de um tipo de vari√°vel, a dist√¢ncia de Gower geralmente deve ser a melhor op√ß√£o  [@pavoine_challenge_2009].

**Exemplo pr√°tico**

**Exemplo1: vari√°veis cont√≠nuas**

Vamos utilizar um conjunto de dados com atributos cont√≠nuos (e.g., √°rea foliar espec√≠fica e massa foliar seca) de 34 esp√©cies de plantas em um gradiente de aridez [@frenette-dussault_functional_2012]. Diversas an√°lises funcionais podem ser afetadas por valores extremos ou pela diferen√ßa de unidade/escala entre as vari√°veis utilizadas. Por este motivo, √© importante padronizar a matriz de atributos com m√©dia 0 e desvio padr√£o 1. Esta padroniza√ß√£o √© necess√°ria tanto para fazer uma PCA como para PCoA (veja Cap√≠tulo \@ref(cap9)).

**Pergunta**

Quais s√£o as esp√©cies de plantas mais semelhantes? (Neste caso, sem predi√ß√£o, pois representa uma avalia√ß√£o explorat√≥ria com as caracter√≠sticas funcionais das esp√©cies).

**Vari√°veis**

- Dependentes: atributos funcionais (matriz de atributos cont√≠nuos por esp√©cie: `trait_fren_dat`)

**An√°lises**

Aqui realizamos os passos para uma ordena√ß√£o usando os atributos funcionais cont√≠nuos (Figura \@ref(fig:fig-func-pcoa-cont)).

```{r fig-func-pcoa-cont, fig.cap="Ordena√ß√£o usando os atributos funcionais cont√≠nuos."}
## PCoA dos atributos cont√≠nuos

# 1. Padroniza√ß√£o dos dados
trait_pad <- decostand(trait_fren_dat, "standardize")
euclid_dis <- vegdist(trait_pad, "euclidean")

# 2. PCoA
# Resultados s√£o id√™nticos aos resultados de uma PCA.
pcoa_traits_cont <- pcoa(euclid_dis, correction = "cailliez") 

# 3. Exportandos dados para gr√°fico
# Ao usar '[,1:2]' voc√™ ir√° selecionar os dois primeiros eixos.
eixos_cont <- as.data.frame(pcoa_traits_cont$vectors[, 1:2]) 

# 4. Gr√°fico de ordena√ß√£o 
plot_trait_cont <- ggplot(eixos_cont, aes(x = Axis.1, y = Axis.2)) + 
    geom_point(pch = 21, size = 4, color = "black", alpha = 0.7, fill = "red2") + 
    geom_text_repel(aes(Axis.1, Axis.2, label = rownames(eixos_cont))) +
    geom_hline(yintercept = 0, linetype = 2) + 
    geom_vline(xintercept = 0, linetype = 2) +
    labs(x = "PCO 1", y = "PCO 2", title = "Dados cont√≠nuos") + 
    tema_livro()
plot_trait_cont
```

**Exemplo 2: vari√°veis categ√≥ricas**

No pr√≥ximo exemplo, utilizamos atributos funcionais de besouros distribu√≠dos na Europa [@barbaro_linking_2009]. Esses dados s√£o categ√≥ricos e incluem atributos como per√≠odo de atividade (noturno, diurno, dioturno), tend√™ncia da popula√ß√£o na europa (est√°vel, aumentando, diminuindo) entre outros.

::: {.alert .alert-info}
<strong> üìù Importante </strong>\
Ao contr√°rio dos dados cont√≠nuos, para dados categ√≥ricos n√£o √© poss√≠vel utilizar PCA.
:::

**Pergunta**

Quais s√£o as esp√©cies de besouros mais semelhantes? (Neste caso, sem predi√ß√£o, pois representa uma avalia√ß√£o explorat√≥ria com as caracter√≠sticas funcionais das esp√©cies).

**Vari√°veis**

- Dependentes: atributos funcionais (matriz de atributos categ√≥ricos por esp√©cie: `trait_dat`)

**An√°lises**

Aqui realizamos os passos para uma ordena√ß√£o usando os atributos funcionais categ√≥ricos (Figura \@ref(fig:fig-func-pcoa-cat)).

```{r fig-func-pcoa-cat, fig.cap="Ordena√ß√£o usando os atributos funcionais categ√≥ricos."}
## PCoA dos atributos categ√≥ricos

# 1. Selecionar somente os atributos categ√≥ricos
trait_cat <- trait_dat %>% 
    dplyr::select_if(is.character)

# 2. Calcular a dist√¢ncia de Gower
dist_categ <- gowdis(trait_cat)

# 3. PCoA da matriz de dist√¢ncia funcional (Gower)
pcoa_traits_cat <- pcoa(dist_categ, correction = "cailliez")

# 4. Exportar dados (escores) para ggplot
eixos_cat <- as.data.frame(pcoa_traits_cat$vectors[,1:2]) # Selecionar os dois primeiros eixos

# 5. Gr√°fico de ordena√ß√£o
plot_trait_cat <- ggplot(eixos_cat, aes(x = Axis.1, y = Axis.2)) + 
    geom_point(pch = 21, size = 4, alpha = 0.7, color = "black", fill = "cyan4") + 
    geom_text_repel(aes(Axis.1, Axis.2, label = rownames(eixos_cat))) +
    geom_hline(yintercept = 0, linetype = 2) + 
    geom_vline(xintercept = 0, linetype = 2) +
    labs(x = "PCO 1", y = "PCO 2", title = "Dados categ√≥ricos") + 
    tema_livro()
plot_trait_cat
```

**Exemplo 3: vari√°veis mistas**

Em casos mais complexos, a pesquisa inclui diversos atributos funcionais com naturezas diferentes, como atributos cont√≠nuos, categ√≥ricos, ordinais, circulares, entre outros. Desse modo, √© poss√≠vel utilizar medidas como Gower (`gowdis()`). Por√©m, existe uma alternativa mais apropriada que generalizou o coeficiente de Gower para tratar cada conjunto de vari√°veis de acordo com sua natureza [@pavoine_challenge_2009]. Vamos usar o mesmo conjunto de dados que foram considerados no exemplo anterior. Por√©m, ao inv√©s de utilizar somente as vari√°veis categ√≥ricas, usaremos todas elas. O primeiro passo √© identificar para o programa as classes apropriadas para cada tipo de vari√°vel e, al√©m disso, preparar os dados para a fun√ß√£o `dist.ktab()`.

**Pergunta**

Quais s√£o as esp√©cies de besouros mais semelhantes? (Neste caso, sem predi√ß√£o, pois representa uma avalia√ß√£o explorat√≥ria com as caracter√≠sticas funcionais das esp√©cies)

**Vari√°veis**

- Dependentes: atributos funcionais (matriz de atributos cont√≠nuos e categ√≥ricos por esp√©cie: `trait_dat`)

**An√°lises**

Aqui realizamos os passos para uma ordena√ß√£o usando os atributos funcionais de diversas naturezas (Figura \@ref(fig:fig-func-pcoa-mistos)).

```{r fig-func-pcoa-mistos, fig.cap="Ordena√ß√£o usando os atributos funcionais de dados mistos."}
## PCoA dos atributos mistos

## 1. Verifique a classe de todos os traits e veja se est√£o de acordo com sua expectativa
trait_dat %>% 
    dplyr::summarise_all(class) %>% 
    tidyr::gather(variable, class)

## 2. Neste exemplo, algumas vari√°veis que s√£o ordinais (regio e body) 
# foram reconhecidas como num√©ricas ou categ√≥ricas. 
trait_dat$regio <- as.ordered(trait_dat$regio)
trait_dat$body <- as.ordered(trait_dat$body)

## 3. Combinar cada conjunto de atributos de acordo com sua natureza em um 
# data.frame separado.
# 3.1. Categ√≥ricos.
trait_categ <- cbind.data.frame(
    trend = trait_dat$trend, 
    redlist = trait_dat$redlist, 
    biog = trait_dat$biog, 
    activ = trait_dat$activ,  
    diet = trait_dat$diet, 
    winter = trait_dat$winter,
    color = trait_dat$color, 
    breed = trait_dat$breed,
    wing = trait_dat$wing, 
    period = trait_dat$period)

# 3.2 Ordinais.
trait_ord <- cbind.data.frame(regio = trait_dat$regio, 
                              body = trait_dat$body)
rownames(trait_categ) <- rownames(trait_dat)
rownames(trait_ord) <- rownames(trait_dat)

# Agora, combinar os dois data.frames em uma lista chamada "ktab".
ktab_list <- ktab.list.df(list(trait_categ, trait_ord))

# Por fim, calcular a dist√¢ncia funcional entre as esp√©cies.
# Em "type", a letra "N" indica vari√°vel categ√≥rica (ou nominal), 
# enquanto a letra "O" indica vari√°vel ordinal.
dist_mist <- dist.ktab(ktab_list, type = c("N", "O"))

## Visualize os dados com uma PCoA
pcoa_traits_mist <- pcoa(dist_mist, correction = "cailliez")
eixos_mist <- as.data.frame(pcoa_traits_mist$vectors[,1:2]) 

plot_trait_mist <- ggplot(eixos_mist, aes(x = Axis.1, y = Axis.2)) + 
    geom_point(pch = 21, size = 4, alpha = 0.7, 
               color = "black", fill = "darkorange") + 
    geom_text_repel(aes(Axis.1, Axis.2, label = rownames(eixos_mist)))+
    geom_hline(yintercept = 0, linetype = 2) + 
    geom_vline(xintercept = 0, linetype = 2) + 
    labs(x = "PCO 1", y = "PCO 2", title = "Dados mistos") + 
    tema_livro()
plot_trait_mist
```

Podemos combinar os dois gr√°ficos (baseado em vari√°veis categ√≥ricas e em vari√°veis mistas) para comparar as duas medidas de dist√¢ncia, uma somente com dados categ√≥ricos (`gower()`) e uma com dados categ√≥ricos e ordinais (`dist.ktab()`) (Figura \@ref(fig:fig-func-pcoa-cat-mistos)).

```{r fig-func-pcoa-cat-mistos, fig.cap="Ordena√ß√µes usando os atributos funcionais categ√≥ricos e de dados mistos."}
## Gr√°ficos
grid.arrange(plot_trait_cat, plot_trait_mist, ncol = 2)
```

## M√©tricas de diversidade funcional (alfa)

### Riqueza funcional

A riqueza funcional mede a quantidade de espa√ßo funcional preenchido pelas esp√©cies de uma comunidade [@mason_functional_2013]. A estimativa desse espa√ßo pode ser calculada usando dendrogramas [@petchey_functional_2002] ou atrav√©s do m√©todo **Convex Hull** [@cornwell_trait-based_2006] que d√£o origem, respectivamente, √†s duas m√©tricas mais usadas: i) Diversidade Funcional (FD) e ii) Riqueza Funcional (FRic). Os √≠ndices de riqueza funcional geralmente s√£o usados como indicadores do espa√ßo de nicho que √© potencialmente usado ou n√£o [@schleuter_users_2010].

**Exemplo pr√°tico**

**Explica√ß√£o dos dados**

Os dados utilizados neste exemplo s√£o os mesmos do exemplo com dados mistos, i.e., categ√≥ricos e cont√≠nuos (objeto `dist_mist`). 

**Pergunta**

Qual a rela√ß√£o entre riqueza de esp√©cies e diversidade funcional? Todos os √≠ndices s√£o correlacionados com a riqueza?

**Vari√°veis**

- Dependentes: atributos funcionais e composi√ß√£o de esp√©cies para c√°lculo da diversidade funcional e riqueza em cada parcela

**An√°lises**

Vamos come√ßar olhando os dados de dissimilaridade das esp√©cies (`dist_mist`) e os dados de composi√ß√£o (`comun_dat`)

```{r message=FALSE, warning=FALSE}
## Estrutura dos dados
# matriz de dist√¢ncia: dist√¢ncia entre as seis primeiras esp√©cies
as.matrix(dist_mist)[1:6, 1:6]

# composi√ß√£o de esp√©cies: seis primeiras esp√©cies nas seis primeiras localidades
head(comun_dat)[1:6, 1:6]
```

Agora vamos calcular a riqueza de esp√©cies por comunidade

```{r message=FALSE, warning=FALSE}
## Riqueza de esp√©cies
richness <- dbFD(dist_mist, comun_dat)$nbsp 
head(richness)
```
Vamos calcular a Riqueza (`FRic`) e Diversidade funcional usando o pacote `dbFD`. 

```{r message=FALSE, warning=FALSE}
# Functional Richness
fric <- dbFD(dist_mist, comun_dat)$FRic
head(fric)

## Functional Diversity 
# Passo 1: an√°lise de agrupamento para criar o dendrograma. 
dend <- hclust(dist_mist, "average")

# Passo 2: transformar o dengrograma em um arquivo da classe phylo.
tree_dend <- as.phylo(dend)

# Passo 3: calcular o valor da diversidade funcional. 
FD <- pd(comun_dat, tree_dend)$PD
head(FD)
```

::: {.alert .alert-info}
<strong> üìù Importante </strong>\
O √≠ndice *Functional Richness* s√≥ funciona para comunidades com 3 ou mais esp√©cies. Caso voc√™ tenha comunidades com 1 ou 2 esp√©cies, o valor ser√° `NA`
:::

Os valores da Riqueza Funcional (FRic) variam entre 0 e +‚àû, sendo o valor m√°ximo limitado pelo n√∫mero de esp√©cies em uma comunidade. Desse modo, os valores de FRic basicamente s√£o uma representa√ß√£o da riqueza de esp√©cies (e seus atributos funcionais) de uma comunidade [@villeger_new_2008]. Ou seja, quanto maior o n√∫mero de esp√©cies, maior ser√° o espa√ßo funcional ocupado por essas esp√©cies. No pacote ‚ÄòdbFD‚Äô o valor de FRic √© dividido pelo valor de FRic global (ou seja, pela riqueza funcional de todas as comunidades combinadas). Como resultado, ele limita a varia√ß√£o entre 0 e 1, onde valores pr√≥ximos a 1 indicam que uma determinada comunidade tem riqueza funcional t√£o alta quanto a riqueza funcional de todas as comunidades juntas. Neste exemplo, as localidades 21 e 89 possuem, respectivamente, a maior e menor Riqueza Funcional. 

### Diverg√™ncia funcional

A diverg√™ncia funcional √© uma medida que descreve a irregularidade na distribui√ß√£o dos valores dos atributos no volume do espa√ßo funcional ocupado por todas as esp√©cies de uma certa comunidade [@garnier_plant_2015]. Para obter os valores de diverg√™ncia, o espa√ßo funcional √© calculado atrav√©s do m√©todo *Convex Hull* (*Functional Divergence*) ou do espa√ßo multidimensional calculado com um PCoA (*Functional Dispersion*). Nos dois casos, o valor da m√©trica representa a dist√¢ncia m√©dia das esp√©cies para o centro de gravidade ou centroide do espa√ßo funcional, ponderado pela abund√¢ncia relativa das esp√©cies [@villeger_new_2008; @laliberte_distance-based_2010]. Desse modo, a diverg√™ncia funcional √© uma medida que calcula o grau de diferencia√ß√£o em que a distribui√ß√£o da abund√¢ncia maximiza a diverg√™ncia entre os atributos funcionais [@mason_functional_2013]. Em geral, estudos que usam esses √≠ndices buscam entender o grau de diferencia√ß√£o de recursos de esp√©cies que coexistem em uma comunidade [@garnier_plant_2015].

Vamos calcular a diverg√™ncia funcional (`FDiv`) e dispers√£o funcional (`FDis`) usando o pacote dbFD. Para isso, usaremos a matriz de dist√¢ncia obtida dos dados `trait_dat` (vari√°veis categ√≥ricas e ordinais) e nomeada como `dist_mist`

```{r message=FALSE, warning=FALSE}
## "Functional Divergence" s
fdiv <- dbFD(dist_mist, comun_dat)$FDiv
head(fdiv)

# "Functional Dispersion" 
fdis <- dbFD(dist_mist, comun_dat)$FDis
head(fdis)
```

::: {.alert .alert-info}
<strong> üìù Importante </strong>\
- O √≠ndice *Functional Divergence* s√≥ funciona para comunidades com 3 ou mais esp√©cies. Caso voc√™ tenha comunidades com 1 ou 2 esp√©cies, o valor ser√° `NA`

- O √≠ndice *Functional Dispersion* s√≥ funciona para comunidades com 3 ou mais esp√©cies. Caso voc√™ tenha comunidades com 1 ou 2 esp√©cies, o valor ser√° zero
:::

Os valores da Diverg√™ncia Funcional (`FDiv`) variam entre 0 e 1. Valores que se aproximam de zero indicam que a esp√©cie mais abundante est√° muito pr√≥xima do valor do atributo m√©dio da comunidade, ao passo que valores pr√≥ximos a 1 indicam que a esp√©cie mais abundante est√° muito distante (ou seja, √© muito diferente) do valor m√©dio da comunidade [@villeger_new_2008]. Neste exemplo, as localidades 159 e 6 possuem, respectivamente, a maior e menor Diverg√™ncia Funcional.

### Regularidade funcional

A regularidade funcional (do ingl√™s *Functional Evenness* - `FEve`) mede o qu√£o regular √© a distribui√ß√£o da abund√¢ncia dos valores dos atributos funcionais no espa√ßo funcional. Diferente dos outros m√©todos, a vers√£o multidimensional deste √≠ndice utiliza um m√©todo chamado *Minimum Spanning Tree* (MST) para conectar todas esp√©cies no espa√ßo funcional. A dist√¢ncia par apar das esp√©cies na MST √© ponderada pela abund√¢ncia relativa das esp√©cies e, desse modo, o valor final da regularidade funcional (FEve) vai variar de 0 (m√°xima irregularidade da distribui√ß√£o da abund√¢ncia ou dist√¢ncia funcional das esp√©cies) a 1 (m√°xima regularidade).

Vamos calcular a Regularidade Funcional (`FEve`) usando o pacote `dbFD`. Para isso, usaremos a matriz de dist√¢ncia obtida dos dados `trait_dat` (vari√°veis categ√≥ricas e ordinais) e nomeada como `dist_mist`

```{r message=FALSE, warning=FALSE}
## "Functional evenness" 
feve <- dbFD(dist_mist, comun_dat)$FEve
head(feve)
```
::: {.alert .alert-info}
<strong> üìù Importante </strong>\
O √≠ndice *Functional evenness* s√≥ funciona para comunidades com 3 ou mais esp√©cies. Caso voc√™ tenha comunidades com 1 ou 2 esp√©cies, o valor ser√° `NA`
:::

Os valores da Regularidade Funcional (FEve) variam entre 0 e 1 (m√°xima regularidade ou regularidade perfeita). A diminui√ß√£o do valor de FEve em dire√ß√£o a zero indica que uma redu√ß√£o da regularidade da distribui√ß√£o da abund√¢ncia ou dist√¢ncia funcional entre as esp√©cies [@villeger_new_2008]. Neste exemplo, as localidades 197 e 175 possuem, respectivamente, a maior e menor Regularidade Funcional. 

### Correla√ß√£o entre as m√©tricas de diversidade funcional (alfa)

Aqui vamos fazer a correla√ß√£o entre as m√©tricas de diversidade funcional (alfa) (Figura \@ref(fig:fig-func-alfa-cor)).

```{r fig-func-alfa-cor, fig.cap="Correla√ß√£o entre as m√©tricas de diversidade funcional (alfa)."}
## Gr√°ficos
## Voc√™ pode criar uma tabela com os resultados de todas as m√©tricas
metricas <- data.frame(richness = richness,
                       FD_gp = FD,
                       fric = fric,
                       fdiv = fdiv,
                       fdis = fdis,
                       feve = feve)
head(metricas)

## Gr√°fico para comparar o comportamento das m√©tricas
ggpairs(metricas) + tema_livro()
```

Os resultados indicam que a Diversidade Funcional de Petchey & Gaston [-@petchey_functional_2002] (r = 0.985) e a riqueza funcional (r = 0.813) s√£o altamente correlacionadas com a riqueza de esp√©cies. Por√©m, a diverg√™ncia funcional, regularidade funcional e dispers√£o funcional n√£o est√£o correlacionadas com a riqueza de esp√©cies.

A figura obtida com o c√≥digo `ggpairs(metricas)` representa uma matriz de correla√ß√£o comparando cada par de vari√°veis (neste caso, os √≠ndices de diversidade). No lado esquerdo da figura (abaixo da diagonal) s√£o representados *scatter plots* (veja Cap√≠tulo \@ref(cap6)), a no lado direito (acima da diagonal) pode-se encontrar os valores das correla√ß√µes (`r`) entre os pares comparados. No caso das correla√ß√µes, quanto mais pr√≥ximo de +1 ou -1, mais forte √© a rela√ß√£o entre essas vari√°veis do par comparado. O gr√°fico de linhas na diagonal demonstra a densidade de cada vari√°veis individualmente (veja Cap√≠tulo \@ref(cap7)).  

## M√©tricas de diversidade funcional (beta)

Assim como na diversidade beta taxon√¥mica (Cap√≠tulo \@ref(cap12)) e na diversidade beta filogen√©tica (Cap√≠tulo \@ref(cap13)), a diversidade beta funcional √© uma medida que compara a composi√ß√£o (e a varia√ß√£o na composi√ß√£o) de atributos funcionais das esp√©cies entre duas ou mais localidades. Por√©m, assim como na medida tradicional taxon√¥mica (como Jaccard ou S√∏rensen), diferen√ßas na diversidade beta podem ser geradas pela **mudan√ßa na identidade das esp√©cies (ou do atributo)** ou na **riqueza de esp√©cies (ou de atributos)** entre duas localidades (Figura \@ref(fig:fig-func)). Desse modo, √© poss√≠vel particionar a diversidade beta funcional em aninhamento (do ingl√™s *nestedness*) e substitui√ß√£o (do ingl√™s *turnover*) (veja Cap√≠tulo \@ref(cap12)). Al√©m disso, os c√°lculos da diversidade beta funcional podem ser realizados par a par (`functional.beta.pair()`) ou para a compara√ß√µes de m√∫ltiplas localidades (`funcional.beta.multi()`).

```{r fig-func, fig.cap="Parti√ß√£o da diversidade beta taxon√¥mica (A) e funcional (B). Os tr√™s cen√°rios apresentados tanto para a diversidade beta taxon√¥mica como funcional representam, respectivamente, diversidade beta explicada somente por substitui√ß√£o, aninhamento e uma combina√ß√£o dos dois."}
knitr::include_graphics(path = "img/cap14_fig01.svg")
```

**Exemplo 4**

Os dados no exemplo a seguir utilizam somente a informa√ß√£o de presen√ßa (1) ou aus√™ncia (0) das esp√©cies nas localidades. Neste exemplo hipot√©tico criado por Baselga et al. [-@baselga_2021], foram amostradas 11 esp√©cies (sp1-sp11) em quatro localidades (A-D). Para cada esp√©cie, criamos dois atributos cont√≠nuos hipot√©ticos (trait1 e trait2).

**Pergunta**

Qual a contribui√ß√£o relativa do aninhamento e substitui√ß√£o para a diversidade beta?

**Vari√°veis**

- Dependentes: atributos funcionais e composi√ß√£o de esp√©cies.

**An√°lises**

Vamos fazer a an√°lise da parti√ß√£o da diversidade beta funcional e comparar seus componentes (Figura \@ref(fig:fig-func-beta-comp)).

```{r fig-func-beta-comp, fig.cap="Rela√ß√£o entre os componentes parti√ß√£o da diversidade funcional (beta)."}
## Parti√ß√£o da Diversidade beta (M√©todo Baselga)
fun_beta_multi <- functional.beta.multi(x = comm_baselga,
                                        trait = trait_baselga, index = "jaccard") 
fun_beta_multi

## Parti√ß√£o da Diversidade beta (M√©todo Baselga)
fun_beta <- functional.beta.pair(x = comm_baselga, 
                                 trait = trait_baselga, index = "jaccard") 

# Os c√≥digos abaixo permitem extrair a matriz de dist√¢ncia (par a par) com a parti√ß√£o em substitui√ß√£o e nestedness
fun_turnover <- fun_beta$funct.beta.jne
fun_nestedness <- fun_beta$funct.beta.jtu
fun_jaccard <- fun_beta$funct.beta.jac

## Gr√°fico de compara√ß√£o do substitui√ß√£o e aninhamento
dat_betapart <- data.frame(turnover = as.numeric(fun_turnover), 
                           nested = as.numeric(fun_nestedness))

## Gr√°fico
plot_betapart <- ggplot(dat_betapart, aes(x = turnover, y = nested)) + 
    geom_point(pch = 21, size = 4, alpha = 0.7, color = "black", fill = "#525252") + 
    labs(x = "Beta Diveristy (Substitui√ß√£o)", y = "Beta Diveristy (Aninhamento)") +
    tema_livro()
plot_betapart
```

Os resultados da an√°lise de parti√ß√£o (`fun_beta_multi()`) indicam que 82,5% (`0,710`/`0,861`) da varia√ß√£o na diversidade beta √© explicada pelo componente substitui√ß√£o, enquanto 17,5% (`0,151`/`0,861`) pelo componente aninhamento. As matrizes de dist√¢ncia obtidas na an√°lise par a par podem ser utilizadas para testar, *a posteriori*, a rela√ß√£o entre gradientes ambientais e diversidade beta funcional (mais detalhes abaixo).

## Composi√ß√£o Funcional (*Community Wegihed Means* - CWM)

As medidas de diversidade beta funcional apresentadas acima fornecem matrizes de dist√¢ncia com compara√ß√µes par a par de localidades em termos da composi√ß√£o de atributos funcionais. Por√©m, muitas vezes o pesquisador quer medir o "atributo m√©dio" da comunidade para investigar, por exemplo, se um determinado gradiente ambiental afeta a express√£o (em termos de abund√¢ncia ou densidade) de dado atributo funcional. Em geral, a medida utilizada √© o CWM (do ingl√™s *Community Wegihed Means*). O CWM √© basicamente uma m√©dia ponderada de um determinado atributo (coluna *m* na matriz T) em rela√ß√£o a abund√¢ncia de todas as esp√©cies que ocorrem na localidade (linha  *n* na matriz X). O c√°lculo no R √© feito pela fun√ß√£o `functcomp()` e usa somente as duas matrizes (T e X). Os leitores que pretendem usar essas m√©tricas devem ler cr√≠ticas em Peres-Neto et al. [-@peres-neto_linking_2017].

```{r}
## Matriz T
head(trait_baselga)

## Matriz X
head(comm_baselga)

## Fun√ß√£o functcomp calcula o cwm para combinar as matrizes T e X
cwm_ex <- functcomp(trait_baselga, as.matrix(comm_baselga))
cwm_ex
```

A matriz resultante `cwm_es` √© formada pelas localidades (linhas) e os atributos "m√©dios" (colunas) nestas localidades. Essa matriz pode ser utilizada em diversas an√°lises como dbRDA, RDA ou RDA parcial (veja Cap√≠tulo \@ref(cap9)). Na sequ√™ncia, vamos utilizar testes de hip√≥teses para entender como podemos calcular as diversidades funcional alfa e beta com outros testes estat√≠sticos apresentados neste livro.

**Exemplo 5**

Neste exemplo, usaremos novamente os dados de 34 esp√©cies de plantas [@frenette-dussault_functional_2012], mas agora vamos testar o efeito de um gradiente de aridez sobre a diversidade alfa funcional.

**Pergunta**

O gradiente de aridez influencia a diverg√™ncia e regularidade funcional de plantas?

**Predi√ß√µes**

- *Predi√ß√£o 1*: locais mais √°ridos possuem menor diverg√™ncia funcional de plantas (m√©trica escolhida: FDis)

- *Predi√ß√£o 2*: locais mais √∫midos possuem menor regularidade funcional de plantas (m√©trica escolhida: FEve)

**Vari√°veis**

- Preditora: gradiente de aridez (matriz de vari√°veis ambientais por localidade: `ambie_fren_dat`)

- Dependentes: composi√ß√£o de esp√©cies (matriz de esp√©cies por localidade: `comun_fren_dat`) e atributos funcionais (matriz de atributos cont√≠nuos por esp√©cie: `trait_fren_dat`)

**An√°lises**

Vamos calcular primeiramente as matrizes de Diverg√™ncia funcional (FDis) e Regularidade Funcional (FEve), depois ajustar modelos lineares, fazer o diagn√≥stico dos mesmo e por fim plotar os resultados (Figura \@ref(fig:fig-func-comp-model)).

```{r fig-func-comp-model, fig.cap="Rela√ß√£o entre a composi√ß√£o funcional e o gradiente de aridez, ajustado por modelos lineares com seus diagn√≥sticos."}
## Passo 1: calcular a dist√¢ncia funcional
trait_pad <- decostand(trait_fren_dat, "standardize")
euclid_dis <- vegdist(trait_pad, "euclidean")

## Passo 2: calcular a Diverg√™ncia funcional (FDis) e Regularidade Funcional (FEve)
fdis <- dbFD(euclid_dis, comun_fren_dat)$FDis # Fdis=0 em locais com somente uma esp√©cie
feve <- dbFD(euclid_dis, comun_fren_dat)$FEve

## Passo 3: Utilizar um modelo linear para comparar o efeito da aridez sobre FDis (predi√ß√£o 1) e FEve (predi√ß√£o 2)
# Combinar dados em um data.frame.
lm_dat <- data.frame(aridez = ambie_fren_dat$Aridity, fdis = fdis, feve = feve)

# Modelo 1
mod1 <- lm(fdis ~ aridez, data = lm_dat)

# Conclus√£o: a aridez n√£o tem efeito sobre a diverg√™ncia funcional
anova(mod1) 

# Modelo 2
mod2 <- lm(feve ~ aridez, data = lm_dat)

# Conclus√£o: a aridez n√£o tem efeito sobre a regularidade funcional
anova(mod2) 

## Passo 4: gr√°fico para visualizar os dois resultados  
# Gr√°fico modelo 1.
plot_pred1 <- ggplot(lm_dat, aes(x = aridez, y = fdis)) + 
    geom_point(pch = 21, size = 4, alpha = 0.7, color = "black", fill="darkorange") +
    labs(x = "Aridez", y = "Diverg√™ncia Funcional (FDis)") +
    tema_livro()

# Gr√°fico modelo 2.
plot_pred2 <- ggplot(lm_dat, aes(x = aridez, y = feve)) + 
    geom_point(pch=21, size=4, alpha = 0.7, color = "black", fill="cyan4") + 
    labs(x = "Aridez", y = "Regularidade Funcional (FEve)") + 
    tema_livro()

## Visualiza√ß√£o dos dois gr√°ficos em um √∫nica janela
grid.arrange(plot_pred1, plot_pred2, ncol = 2)
```

Os resultados dos modelos `anova(mod1)` e `anova(mod2)` indicam que o gradiente de aridez n√£o afeta a dispers√£o e regularidade funcional. Os detalhes para conferir os pressupostos das an√°lises foram descritos no Cap√≠tulo \@ref(cap7).

**Exemplo 6**

Agora, vamos utilizar novamente os dados de 34 esp√©cies de plantas [@frenette-dussault_functional_2012], mas agora para testar o efeito do pastejo sobre a diversidade beta funcional.

**Pergunta**

O pastejo determina a ocorr√™ncia de esp√©cies de plantas com diferentes atributos funcionais?

**Predi√ß√£o** 

- A composi√ß√£o funcional de plantas √© diferente entre √°reas com e sem pastejo?

**Vari√°veis**

- Preditora: √°reas com e sem pastejo de gado (vari√°vel categ√≥rica com dois n√≠veis: *grazed* e *ungrazed*: `ambie_fren_dat`)

- Dependentes: composi√ß√£o de esp√©cies (matriz de esp√©cies por localidade: `comun_fren_dat`) e atributos funcionais (matriz de atributos cont√≠nuos por esp√©cie: `trait_fren_dat`)

**An√°lises**

Nesse exemplo vamos calcular a CWM e depois usar uma PERMANOVA (Cap√≠tulo \@ref(cap9)) para comparar o efeito das √°reas com e sem pastejo sobre a diversidade funcional (Figura \@ref(fig:fig-func-cwm-model)).

```{r fig-func-cwm-model, fig.cap="Rela√ß√£o do pastejo sobre a composi√ß√£o funcional."}
## Passo 1: CWM
cwm_fren <- functcomp(trait_pad, as.matrix(comun_fren_dat))
head(cwm_fren)

## Passo 2: calcular a dist√¢ncia funcional
cwm_dis <- vegdist(cwm_fren, "euclidean")

## Passo 3: testar se a composi√ß√£o funcional varia entre as √°reas com uma PERMANOVA
perman_fren <- adonis(cwm_fren ~ Grazing, data = ambie_fren_dat)

## Passo 4: comparar a varia√ß√£o dentro de cada grupo com Betadisper 
betad_fren <- betadisper(cwm_dis, ambie_fren_dat$Grazing)
permutest(betad_fren)

## Passo 5: PCoA

cwm_pcoa <- pcoa(D = cwm_dis, correction = "cailliez")
pcoa_eixos <- cwm_pcoa$vectors[, 1:2]
pcoa_dat <- data.frame(pastagem = ambie_fren_dat$Grazing, pcoa_eixos)

## Passo 6: definir os grupos ("HULL") para serem categorizados no gr√°fico 

grp.Grazed <- pcoa_dat[pcoa_dat$pastagem == "Grazed", ][chull(pcoa_dat[pcoa_dat$pastagem == "Grazed", c("Axis.1", "Axis.2")]), ]
grp.Ungrazed <- pcoa_dat[pcoa_dat$pastagem == "Ungrazed", ][chull(pcoa_dat[pcoa_dat$pastagem == "Ungrazed", c("Axis.1", "Axis.2")]), ]
hull_cwm <- rbind(grp.Grazed, grp.Ungrazed) 

## Passo 7: Gr√°fico biplot

100 * (cwm_pcoa$values[, 1]/cwm_pcoa$trace)[1] # % de explica√ß√£o do eixo 1
100 * (cwm_pcoa$values[, 1]/cwm_pcoa$trace)[2] # % de explica√ß√£o do eixo 2

ggplot(pcoa_dat, aes(x = Axis.1, y = Axis.2, color = pastagem, shape = pastagem)) + 
  geom_point(size = 4, alpha = 0.7) + 
  geom_polygon(data = hull_cwm, aes(fill = pastagem, group = pastagem), alpha = 0.3) + 
  scale_color_manual(values = c("darkorange", "cyan4")) +
  scale_fill_manual(values = c("darkorange", "cyan4")) +
  labs(x = "PCO 1 (53.6%)", y = "PCO 2 (24.6%)") + 
  tema_livro()


```

Neste exemplo, os resultados `perman_fren` demonstram que a composi√ß√£o funcional de plantas n√£o √© afetada pelo pastejo (P \> 0,05) e que a dispers√£o da composi√ß√£o [uma medida potencial de diversidade beta: @anderson_multivariate_2006] de esp√©cies tamb√©m n√£o muda entre √°reas com ou sem pastejo (`permutest(betad_fren)`). A fun√ß√£o `betadisper()` deve ser sempre utilizada em conjunto com a PERMANOVA (`adonis()`) para poder interpretar quais as fontes de varia√ß√£o na composi√ß√£o de esp√©cies. Sendo assim, esta an√°lise representa um m√©todo fundamental para comparar se o potencial efeito (quando houver) √© fruto de diferen√ßa na composi√ß√£o de esp√©cies (i.e., diferen√ßa na posi√ß√£o dos centroides entre dois ou mais grupos) ou na varia√ß√£o da composi√ß√£o de esp√©cies entre os grupos (i.e., diferen√ßa na dispers√£o dos dados em rela√ß√£o aos centroides, ver mais no Cap√≠tulo \@ref(cap9)). Esta √∫ltima informa√ß√£o, a dispers√£o, √© geralmente interpretada como uma analogia a homogeneidade de vari√¢ncias de uma ANOVA (i.e., Teste de Levene). A hip√≥tese nula do `betadisper()` √© que a dispers√£o dos grupos √© homog√™nea (ou seja, o valor de probabilidade nos casos que existem dispers√µes homog√™neas ser√° maior do que 0,05). Por√©m, se esse valor de p for menor do que 0,05, voc√™ deve rejeitar a hip√≥tese nula e concluir que as dispers√µes s√£o heterog√™neas. 

Os gr√°ficos de PCoA s√£o uma ferramenta poderosa para interpretar os resultados da PERMANOVA + Betadisper. Quanto mais diferente a composi√ß√£o de esp√©cies entre dois ou mais grupos, mais distante devem ser os centroides desses grupos. Al√©m disso, se as √°reas dos pol√≠gonos que conectam todas as r√©plicas de cada grupo forem diferentes em tamanho (hip√≥tese que ser√° testada com o Betadisper), √© poss√≠vel tamb√©m visualizar esta diferen√ßa. Em conclus√£o, para testar se diferen√ßas de composi√ß√£o funcional existem entre dois ou mais grupos, ser√° fundamental: i) comparar a varia√ß√£o da posi√ß√£o dos centr√≥ides (fun√ß√£o `adonis()`) e ii) a varia√ß√£o da dispers√£o da composi√ß√£o funcional entre os grupos (fun√ß√£o `betadisper()`).

##  Varia√ß√£o Intraespec√≠fica

Os m√©todos discutidos anteriormente utilizam valores m√©dios dos atributos das esp√©cies para descrever a estrutura funcional da comunidade e interpretar as rela√ß√µes entre determinadas vari√°veis preditoras (como clima, por exemplo) com a diversidade funcional. Por√©m, ao utilizar atributos m√©dios estamos desconsiderando que a varia√ß√£o deste atributo dentro da esp√©cie seja determinante para a resposta da esp√©cie ao ambiente ou seu efeito sobre o ecossistema [@bolnick_why_2011 ; @violle_return_2012]. Os estudos que usam dados m√©dios para testar hip√≥teses em ecologia funcional argumentam que a varia√ß√£o dentro das esp√©cie √© menor do que a varia√ß√£o entre esp√©cies e, desse modo, o ru√≠do causado ao desconsiderar a vari√¢ncia do atributo dentro da esp√©cies √© desprez√≠vel [@siefert_global_2015]. Por√©m, diversos estudos t√™m mostrado que esse argumento √© fr√°gil e que a inclus√£o da varia√ß√£o intraespec√≠fica melhora nossa capacidade preditiva em ecologia funcional [@violle_return_2012; @siefert_global_2015]. Uma abordagem geralmente utilizada √© a decomposi√ß√£o da vari√¢ncia do atributo em diferentes n√≠veis de organiza√ß√£o: i) varia√ß√£o dentro da popula√ß√£o da mesma esp√©cie em uma mesma unidade amostral, ii) varia√ß√£o dentro das popula√ß√µes (independente da esp√©cie) de uma comunidade em uma mesma unidade amostral, e iii) varia√ß√£o entre popula√ß√µes. Conhecida como estat√≠stica T, esta abordagem permite entender as fontes (intra ou interespec√≠fica) de varia√ß√£o nos atributos em diferentes escalas [@violle_return_2012]. Outro m√©todo que quantifica a vari√¢ncia explicada pela variabilidade intraespec√≠fica, interespec√≠fica e a covari√¢ncia entre elas foi proposto por Leps et al. [-@leps_community_2011]. Este m√©todo permite calcular a contribui√ß√£o da varia√ß√£o intraespec√≠fica dentro e entre comunidades. Agora, vamos entender a contribui√ß√£o da varia√ß√£o de um atributo dentro da esp√©cie comparada √† varia√ß√£o entre esp√©cies.

**Exemplo 7**

Vamos utilizar os dados de 11 esp√©cies de anuros associados com 26 po√ßas no Parque Nacional Lagoa do Peixe [@dalmolin_turnover_2020]. Atributos morfol√≥gicos foram coletados em todos os indiv√≠duos coletados em cada po√ßa. Desse modo, √© poss√≠vel comparar a varia√ß√£o morfol√≥gica entre indiv√≠duos da mesma esp√©cie e entre esp√©cies diferentes. Al√©m disso, √© poss√≠vel quantificar a contribui√ß√£o da varia√ß√£o dentro e entre diferentes po√ßas. No exemplo abaixo, criamos cinco atributos com nomes diferentes daqueles usados no artigo de Dalmolin et al. [-@dalmolin_turnover_2020]. Em cada po√ßa, os autores coletaram os seguintes dados das po√ßas: i) profundidade, ii) area, iii) dist√¢ncia entre po√ßas, e iv) dist√¢ncia da po√ßa para a floresta mais pr√≥xima.

**Pergunta 1**

Qual a contribui√ß√£o da varia√ß√£o intraespec√≠fica para a varia√ß√£o total dos atributos morfol√≥gicos de anuros?

**Predi√ß√£o** 

- A alta plasticidade fenot√≠pica de anuros indica alta contribui√ß√£o da varia√ß√£o intraespec√≠fica comparada a interespec√≠fica

**Vari√°veis**

- Preditora: esp√©cies (categ√≥rica)
- Dependente: varia√ß√£o dos atributos morfol√≥gicos

**An√°lises**

Aqui vamos realizar o passo a passo das an√°lises para comparar a contribui√ß√£o da varia√ß√£o intraespec√≠fica para a varia√ß√£o total dos atributos morfol√≥gicos.

```{r}
## Dados necess√°rios
# Matriz de traits.
head(traits)

## Parti√ß√£o da varia√ß√£o intra e interespec√≠fica
## Passo 1: Tamanho corporal
mod_body_size <- aov(body_size~Species, data = traits)
summary(mod_body_size)

# Contribui√ß√£o da varia√ß√£o intra-espec√≠fica para o tamanho corporal.
itv_BS <- 100 * (73.35/(95.92 + 73.35))
itv_BS

## Passo 2: Biomassa
mod_biomass <- aov(biomass~Species, data = traits)
summary(mod_biomass)

# Contribui√ß√£o da varia√ß√£o intra-espec√≠fica para a biomassa.
itv_biomass <- 100 * (96.22/(118.17 + 96.22))
itv_biomass

## Passo 3: Tamanho do olho
mod_eye_size <- aov(eye_size ~ Species, data = traits)
summary(mod_eye_size)

# Contribui√ß√£o da varia√ß√£o intra-espec√≠fica para o tamanho do olho.
itv_eye_size <- 100 * (78.39/(203.09 + 78.39))
itv_eye_size

## Passo 4: Achatamento dorso-ventral
mod_flatness <- aov(flatness~Species, data = traits)
summary(mod_flatness)

# Contribui√ß√£o da varia√ß√£o intra-espec√≠fica para o achatamento dorso-ventral.
itv_flatness <- 100 * (22.13/(104.48 + 22.13))
itv_flatness

## Passo 5: Combinar os valores de cada trait em um vetor
valores <- c(itv_BS, itv_biomass, itv_eye_size, itv_flatness)

# Passo 6: Combinar valores e traits em um data.frame.
itv_results <- data.frame(trait = c("body_size", "biomass", "eye_size", "flatness"),
                          itv_explic = valores)

## Tabela com resultados da explica√ß√£o atribuida para a varia√ß√£o intraespec√≠fica
itv_results %>%
    mutate("explained intraspecific variance" = round(itv_explic, 2)) %>% 
    dplyr::select(trait, "explained intraspecific variance")
```

**Pergunta 2**

Qual a contribui√ß√£o da varia√ß√£o entre po√ßas para a varia√ß√£o total dos atributos morfol√≥gicos de anuros?

**Predi√ß√£o**

- A varia√ß√£o morfol√≥gica de anuros √© afetada por mudan√ßas dentro das esp√©cies e entre diferentes esp√©cies de po√ßas distintas

**Vari√°veis**

- Preditoras: po√ßas e esp√©cies (ambas categ√≥ricas)
- Dependente: varia√ß√£o dos atributos morfol√≥gicos

**An√°lises**

Aqui vamos realizar o teste para comparar a contribui√ß√£o da varia√ß√£o entre po√ßas para a varia√ß√£o total dos atributos morfol√≥gicos (Figura \@ref(fig:fig-func-intra)).

```{r fig-func-intra, fig.cap="Gr√°fico de barras mostrando a contribui√ß√£o da varia√ß√£o entre po√ßas para a varia√ß√£o total dos atributos morfol√≥gicos."}
## Dados necess√°rios
# Matriz de traits sem nomes de esp√©cies ou localidades
trait_m <- traits[, c("body_size", "biomass", "eye_size", "leg_size", "flatness")]
head(trait_m)
trait_decomp <- decompCTRE(traits = trait_m, sp = traits$Species, 
                           ind.plot = traits$pond, print = FALSE)
barplot.decompCTRE(trait_decomp)
```

**Pergunta 3**

Caracter√≠sticas ambientais das po√ßas afetam a varia√ß√£o intraespec√≠fica?

**Predi√ß√£o** 

- A profundidade e √°rea da po√ßa aumentam a contribui√ß√£o da varia√ß√£o intraespec√≠fica em rela√ß√£o a varia√ß√£o interespec√≠fica.

**Vari√°veis**

- Preditora: caracter√≠sticas das po√ßas
- Dependentes: varia√ß√£o dos atributos morfol√≥gicos e contribui√ß√£o da varia√ß√£o intraespec√≠fica

**An√°lises**

Para calcular a contribui√ß√£o relativa da varia√ß√£o intraespec√≠fica em rela√ß√£o √† varia√ß√£o interespec√≠fica dentro de uma comunidade, por exemplo, Siefert et al. [-@siefert_global_2015] sugeriram uma m√©trica chamada de wITV (*within-community Intraspecific Trait Variation*). A wITV representa a raz√£o da varia√ß√£o intraespec√≠fica em rela√ß√£o a varia√ß√£o total dentro de uma comunidade (e.g., parcela, po√ßa) que inclui: i) a abund√¢ncia relativa de cada esp√©cie *j* ocorrendo na comunidade *i*, ii) o valor m√©dio do atributo da esp√©cie *j* na comunidade *i*, e iii) o valor do atributo *k* de cada indiv√≠duo da esp√©cie *j* que ocorre na comunidade *i*. Como esta medida √© feita por unidade amostral (ou seja, sua comunidade de interesse), √© poss√≠vel testar hip√≥teses ecol√≥gicas que tentem explicar processos que aumentem ou diminuam a varia√ß√£o de um determinado atributo dentro ou entre esp√©cies diferentes. A fun√ß√£o wITV foi adaptada para a linguagem R por de Bello et al. [-@de_bello_handbook_2021]. Para facilitar o c√°lculo do wITV para cada comunidade, de Bello et al. [-@de_bello_handbook_2021] executaram os c√≥digos com a fun√ß√£o `for()` que repete iterativamente a an√°lise para gerar os valores de todas as comunidades em uma forma din√¢mica. Ap√≥s executar as an√°lises com o `for()`, a fun√ß√£o salva os resultados dentro do objeto `wITVResults`. Ap√≥s obter esses resultados, √© poss√≠vel utilizar modelos lineares para testar quais vari√°veis preditoras (em nosso exemplo, caracter√≠sticas das po√ßas) afetam o aumento ou diminui√ß√£o da contribui√ß√£o relativa da varia√ß√£o intraespec√≠fica (Figura \@ref(fig:fig-func-witv)).

```{r fig-func-witv, fig.cap="Gr√°ficos diagn√≥sticos do modelo linear ajustado para iWTV em fun√ß√£o de caracter√≠sticas das po√ßas."}
## Dados necess√°rios
# Matriz de traits.
head(traits)

# Matriz de comunidades e padroniza√ß√£o para abund√¢ncia relativa
head(anuros_comm)
anuros_comm_rel <- decostand(anuros_comm, "total")

# Vari√°veis ambientais.
head(env)

## Preara√ß√£o da matriz para receber os resultados do `for`
wITVResults <- data.frame(ITV = matrix(ncol = 1, nrow = length(unique(traits$pond))))
rownames(wITVResults) <- unique(traits$pond)

for(i in 1:length(unique(traits$pond))){
    commAux <- subset(traits, traits$pond == unique(traits$pond)[i])
    commAux$Species <- droplevels(factor(commAux$Species))
    spNames <- unique(commAux$Species)
    relAbund <- anuros_comm_rel[i, as.character(spNames)] 
    traitsVector <- commAux$body_size
    spVector <- commAux$Species
    wITVResults[i, 1] <-  wITV(spIDs = spVector, traitVals = traitsVector, relAbund = relAbund)
}

wITVResults$ITV
env$wITV <- wITVResults$ITV # NaN = locais com uma √∫nica esp√©cie

## Remover NAs para executar o modelo linear
env2 <- na.omit(env)
head(env2)  

## Modelo linear 
mod_itv <- lm(wITV ~ depth + area + dits_bt_pond + dist_for, data = env)

## Testar pressuposto da an√°lise
par(mfrow = c(2, 2))
plot(mod_itv)

## Resultado
summary(mod_itv)
```

Combinando os resultados das tr√™s an√°lises √© poss√≠vel compreender que existem diferen√ßas morfol√≥gicas entre as esp√©cies de po√ßas diferentes (componente substitui√ß√£o). Por√©m, √© evidente que a varia√ß√£o dentro da esp√©cie √© bastante relevante para compreender a diversidade funcional de anuros. Na primeira an√°lise, os resultados dessas quatro an√°lises indicaram que a varia√ß√£o intraespec√≠fica explica de 17% a 45% da varia√ß√£o morfol√≥gica nas metacomunidades de anuros. A segunda, por sua vez, demonstra que a varia√ß√£o morfol√≥gica entre esp√©cies de po√ßas diferentes representa o principal componente de varia√ß√£o, mas que a varia√ß√£o intraespec√≠fica n√£o pode ser ignorada. Por fim, ao combinar a m√©trica wITV com modelos lineares, percebe-se que as caracter√≠sticas das po√ßas n√£o determinam a contribui√ß√£o da varia√ß√£o intraespec√≠fica. Al√©m disso, existe uma varia√ß√£o muito grande entre po√ßas. Ao passo que em algumas po√ßas a varia√ß√£o intraespec√≠fica n√£o contribui para a varia√ß√£o total (wITV = 0), em outras, este componente representou 100% da varia√ß√£o (wITV = 1). Os resultados obtidos nas an√°lises das perguntas 1 a 3 indicam que utilizar somente a m√©dia dos atributos morfol√≥gicos pode refletir em interpreta√ß√µes incorretas em estudos que compararam a diversidade funcional no espa√ßo/tempo [veja discuss√£o em @dalmolin_turnover_2020].

## Para se aprofundar 

### Livros 
Recomendamos a leitura dos livros: i) Garnier et al. [-@garnier_plant_2016] *Plant Functional Diversity: Organism Traits, Community Structure, and Ecosystem Properties*, e ii) de Bello et al. [-@de_bello_handbook_2021] *Handbook of Trait-Based Ecology*.  Esses livros oferecem excelente oportunidade para se aprofundar no campo te√≥rico da diversidade funcional e, al√©m disso, o livro liderado pelo pesquisador Francesco de Bello fornece diversas aplica√ß√µes anal√≠ticas na linguagem R. Outro recurso excelente foi publicado por Mammola et al. [-@mammola_concepts_2021] *Concepts and Applications in Functional Diversity* e serve para se aprofundar nas diferentes medidas da diversidade funcional.

### Links

Um passo importante nos estudos de Diversidade Funcional √© encontrar atributos funcionais dos organismos estudados. Abaixo indicamos uma lista de potenciais bases de dados:

- [COMADRE - Animal Matrix Database](https://compadre-db.org/)
- [COMPADRE - Plant Matrix Database](https://compadre-db.org/)
- [Elton Traits 1.0](https://esajournals.onlinelibrary.wiley.com/doi/10.1890/13-1917.1)
- [TetraDENSITY - Density estimates in terrestrial vertebrates](https://figshare.com/articles/dataset/TetraDENSITY_Population_Density_dataset/5371633?file=11358218)
- [TRY - Plant Trait Database](https://www.try-db.org/TryWeb/Home.php)
- [World Spider Trait](https://spidertraits.sci.muni.cz/)
 
## Exerc√≠cios

**14.1**
Utilize os dados `aviurba` do pacote `ade4` para testar o efeito de vari√°veis ambientais na dispers√£o (FDis) e regularidade funcional (FEve). Utilize modelos lineares (LM, veja Cap√≠tulo \@ref(cap7)) para testar quais vari√°veis ambientais s√£o as mais importantes para a dispers√£o e regularidade funcional. Al√©m disso, fa√ßa um boxplot (veja Cap√≠tulo \@ref(cap6)) comparando os valores de FDis e FEve entre as categorias das vari√°veis ambientais mais relevantes. 

**14.2**
Utilize os dados `mafragh` do pacote `ade4` para teste o efeito da das vari√°veis `conductivity`, `silt` e `K2O` na diversidade funcional (m√©todo de Petchey e Gaston). Utilize modelos lineares (regress√£o m√∫ltipla, veja Cap√≠tulo \@ref(cap7)) para testar a rela√ß√£o entre essas vari√°veis e discuta: (a) qual vari√°vel mais importante (se houver) e (b) se as conclus√µes s√£o coerentes tendo como base os pressupostos dos modelos lineares. Al√©m disso, caso exista alguma rela√ß√£o significativa, fa√ßa um gr√°fico (*scatterplot*, veja Cap√≠tulo \@ref(cap6)) da rela√ß√£o da vari√°vel mais importante e a diversidade funcional.

**14.3**
Utilize os dados `mafragh` do pacote `ade4` para comparar a composi√ß√£o filogen√©tica e funcional em √°reas com alta e baixa concentra√ß√£o de pot√°ssio. Para fazer esta compara√ß√£o ser√° necess√°rio transformar a matriz de atributos funcionais e a √°rvore filogen√©tica em matrizes de dist√¢ncia e, depois, utilizar o CWM para criar uma matriz de localidades por composi√ß√£o funcional ou filogen√©tica. Depois, voc√™ poder√° usar a matriz CWM para testar potenciais diferen√ßas entre concentra√ß√µes com PERMANOVA e para visualizar com PCoA.

[Solu√ß√µes dos exerc√≠cios](https://exercicios-livro-aer.netlify.app/cap.-14---diversidade-funcional.html).
